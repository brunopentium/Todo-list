<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Offline</title>
    
    <!-- Carregando React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Carregando Babel para interpretar JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Carregando Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .subtask-done { text-decoration: line-through; color: #94a3b8; }
        
        /* Animation for modals */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- UTILS ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        
        const addDays = (dateStr, days) => {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        };

        const isWeekend = (dateStr) => {
            const day = new Date(dateStr + 'T00:00:00').getDay();
            return day === 0 || day === 6;
        };

        const addBusinessDays = (dateStr, businessDays) => {
            if (businessDays === 0) return dateStr;

            let current = dateStr;
            let remaining = Math.abs(businessDays);
            const direction = businessDays > 0 ? 1 : -1;

            while (remaining > 0) {
                current = addDays(current, direction);
                if (!isWeekend(current)) {
                    remaining -= 1;
                }
            }

            return current;
        };

        const getNextBusinessDay = (dateStr) => {
            return isWeekend(dateStr) ? addBusinessDays(dateStr, 1) : dateStr;
        };

        const getBusinessDayShift = (fromDateStr, toDateStr) => {
            if (!fromDateStr || !toDateStr || toDateStr <= fromDateStr) return 0;

            let current = fromDateStr;
            let shift = 0;

            while (current < toDateStr) {
                current = addBusinessDays(current, 1);
                shift += 1;
            }

            return shift;
        };

        const getBusinessDayDistance = (fromDateStr, toDateStr) => {
            if (!fromDateStr || !toDateStr || fromDateStr === toDateStr) return 0;

            const step = toDateStr > fromDateStr ? 1 : -1;
            let current = fromDateStr;
            let distance = 0;

            while (current !== toDateStr) {
                current = addDays(current, step);
                if (!isWeekend(current)) {
                    distance += step;
                }
            }

            return distance;
        };

        const getEffectiveDate = (task) => {
            if (!task?.date) return '';
            if (task.status === 'Recorrente') return task.date;

            const delay = Number(task.deferBusinessDays) || 0;
            if (!delay) return task.date;

            return addBusinessDays(task.date, delay);
        };

        const formatDate = (year, month, day) => {
            const date = new Date(Date.UTC(year, month, day));
            return date.toISOString().split('T')[0];
        };

        const getDaysInMonth = (year, month) => {
            return new Date(year, month + 1, 0).getDate();
        };

        // --- ICONS (Lucide wrapper for React) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const defaultConfig = {
            alertYellow: 7,
            alertOrange: 3,
            alertRed: 1,
            overdueColor: 'border-l-slate-900',
            todayBg: '#fef9c3',
            tomorrowBg: '#ffedd5',
            deadlineBg: '#fee2e2'
        };

        const defaultRecurrence = {
            frequency: 'Nenhuma',
            daysOfWeek: [],
            daysOfMonth: []
        };

        const STATUS_OPTIONS = ['Em Andamento', 'Recorrente', 'Concluída', 'Cancelada'];

        const STATUS_COLORS = {
            'Pendente': 'bg-slate-200 text-slate-700',
            'Em Andamento': 'bg-blue-100 text-blue-700',
            'Concluída': 'bg-green-100 text-green-700',
            'Cancelada': 'bg-red-100 text-red-700',
            'Recorrente': 'bg-purple-100 text-purple-700'
        };

        const WEEKDAY_LABELS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

        // --- COMPONENTS ---

        // 1. STATUS BADGE
        const StatusBadge = ({ status, onClick, className = '' }) => {
            const Element = onClick ? 'button' : 'span';
            return (
                <Element
                    type={onClick ? 'button' : undefined}
                    onClick={onClick}
                    className={`px-2 py-1 rounded-full text-xs font-bold ${STATUS_COLORS[status] || STATUS_COLORS['Pendente']} ${onClick ? 'cursor-pointer hover:opacity-90 transition' : ''} ${className}`}
                >
                    {status}
                </Element>
            );
        };

        // 2. RATING DISPLAY / EDITOR (Priority/Difficulty)
        const RatingDisplay = ({ value, max = 5, color = "text-yellow-500", onChange, label }) => {
            return (
                <div className="flex items-center gap-1">
                    {label && <span className="font-semibold text-slate-500">{label}</span>}
                    <div className="flex space-x-0.5">
                        {[...Array(max)].map((_, i) => (
                            <button
                                key={i}
                                type="button"
                                onClick={() => onChange && onChange(i + 1)}
                                className={`text-xs leading-none ${i < value ? color : "text-slate-300"} ${onChange ? 'hover:scale-110 transition-transform' : ''}`}
                                aria-label={onChange ? `${label || 'Nível'} ${i + 1}` : undefined}
                            >
                                ●
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const PostponeSelector = ({ baseDate, onShift, disabled = false }) => {
            const pastDays = 7;
            const futureDays = 14;
            const referenceDate = baseDate || getTodayStr();

            const offsets = useMemo(
                () => [...Array(pastDays + futureDays + 1)].map((_, i) => i - pastDays),
                [referenceDate]
            );

            const handleSelect = (offset) => {
                if (disabled || offset === 0) return;
                if (onShift) onShift(offset);
            };

            return (
                <div className="flex items-center gap-1" title="Ajustar data de execução por dia da semana">
                    <span className="text-[11px] font-semibold text-slate-500">Reagendar:</span>
                    <div className="flex items-center gap-1 overflow-x-auto flex-nowrap">
                        {offsets.map((offset) => {
                            const targetDate = addDays(referenceDate, offset);
                            const weekdayIndex = new Date(targetDate + 'T00:00:00').getDay();
                            const weekdayLabel = WEEKDAY_LABELS[weekdayIndex];
                            const isWeekendDay = weekdayIndex === 0 || weekdayIndex === 6;
                            const isCurrent = offset === 0;
                            const description = offset === 0
                                ? 'Data atual de execução'
                                : `${offset > 0 ? 'Adiar' : 'Adiantar'} para ${targetDate.split('-').reverse().join('/')}`;

                            const colorClasses = isWeekendDay
                                ? 'text-red-500 hover:text-red-600'
                                : isCurrent
                                    ? 'text-blue-700'
                                    : 'text-slate-600 hover:text-blue-600';

                            return (
                                <button
                                    key={offset}
                                    type="button"
                                    disabled={disabled}
                                    onClick={() => handleSelect(offset)}
                                    className={`min-w-[22px] h-5 text-[10px] font-semibold rounded border leading-none flex items-center justify-center transition-colors ${isCurrent ? 'bg-blue-50 border-blue-400 shadow-sm' : 'border-slate-200 hover:border-blue-300'} ${colorClasses} ${disabled ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}`}
                                    aria-label={description}
                                    title={description}
                                >
                                    {weekdayLabel}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // 3. MAIN APP
        function App() {
            // --- STATE ---
            const [tasks, setTasks] = useState([]);
            const [projects, setProjects] = useState(['Pessoal', 'Trabalho']);
            const [view, setView] = useState('dashboard'); // dashboard, settings, conflicts
            const [modalOpen, setModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [expandedSubtasks, setExpandedSubtasks] = useState({});
            const [expandedNotes, setExpandedNotes] = useState({});
            const [editingDateId, setEditingDateId] = useState(null);
            const [editingDeadlineId, setEditingDeadlineId] = useState(null);
            const [editingTitleId, setEditingTitleId] = useState(null);
            const [titleDrafts, setTitleDrafts] = useState({});
            const [statusMenuTask, setStatusMenuTask] = useState(null);
            const [inlineSubtaskText, setInlineSubtaskText] = useState({});
            const [editingSubtask, setEditingSubtask] = useState(null);
            const [subtaskDrafts, setSubtaskDrafts] = useState({});
            const [reprogramOffset, setReprogramOffset] = useState('');
            
            // Configurações padrão
            const [config, setConfig] = useState(defaultConfig);

            const [filters, setFilters] = useState({
                project: 'Todos',
                status: 'Aberta',
                search: '',
                dateFilter: 'Todos',
                startDate: '',
                endDate: ''
            });

            const normalizeTask = (task) => ({
                ...task,
                status: task.status === 'Pendente' ? 'Em Andamento' : task.status,
                recurrence: { ...defaultRecurrence, ...(task.recurrence || {}) },
                deferBusinessDays: Number(task.deferBusinessDays) || 0
            });

            const toggleNotesVisibility = (taskId) => {
                setExpandedNotes(prev => ({ ...prev, [taskId]: !prev[taskId] }));
            };

            const getNextRecurrenceDate = (task) => {
                const recurrence = { ...defaultRecurrence, ...(task.recurrence || {}) };
                if (task.status !== 'Recorrente' || recurrence.frequency === 'Nenhuma') return null;

                const baseDate = task.date || getTodayStr();

                if (recurrence.frequency === 'Diária') {
                    return addDays(baseDate, 1);
                }

                if (recurrence.frequency === 'Semanal') {
                    const days = (recurrence.daysOfWeek || []).map(Number);
                    if (days.length === 0) return null;
                    for (let i = 1; i <= 14; i++) {
                        const candidateStr = addDays(baseDate, i);
                        const day = new Date(candidateStr + 'T00:00:00').getDay();
                        if (days.includes(day)) return candidateStr;
                    }
                    return null;
                }

                if (recurrence.frequency === 'Mensal') {
                    const days = (recurrence.daysOfMonth || [])
                        .map(Number)
                        .filter(d => d >= 1 && d <= 31)
                        .sort((a, b) => a - b);

                    if (days.length === 0) return null;

                    const currentDate = new Date(baseDate + 'T00:00:00');
                    const currentDay = currentDate.getDate();
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const daysInMonth = getDaysInMonth(year, month);

                    const nextDaySameMonth = days.find(d => d > currentDay && d <= daysInMonth);
                    if (nextDaySameMonth) {
                        return formatDate(year, month, nextDaySameMonth);
                    }

                    let nextMonth = month + 1;
                    let nextYear = year;
                    if (nextMonth > 11) {
                        nextMonth = 0;
                        nextYear += 1;
                    }

                    const nextMonthDays = getDaysInMonth(nextYear, nextMonth);
                    const validDay = days.find(d => d <= nextMonthDays) || nextMonthDays;
                    return formatDate(nextYear, nextMonth, validDay);
                }

                return null;
            };

            const recurrenceDescription = (recurrence) => {
                const data = { ...defaultRecurrence, ...(recurrence || {}) };
                if (data.frequency === 'Diária') return 'Diária';
                if (data.frequency === 'Semanal') {
                    const days = (data.daysOfWeek || []).map(Number).sort((a, b) => a - b);
                    if (!days.length) return 'Semanal';
                    return `Semanal (${days.map(d => WEEKDAY_LABELS[d]).join(', ')})`;
                }
                if (data.frequency === 'Mensal') {
                    const days = (data.daysOfMonth || []).map(Number).filter(Boolean).sort((a, b) => a - b);
                    if (!days.length) return 'Mensal';
                    return `Mensal (dias ${days.join(', ')})`;
                }
                return 'Sem recorrência';
            };

            // --- PERSISTENCE ---
            useEffect(() => {
                const savedTasks = localStorage.getItem('tm_tasks');
                const savedProjects = localStorage.getItem('tm_projects');
                const savedConfig = localStorage.getItem('tm_config');
                if (savedTasks) {
                    const parsedTasks = JSON.parse(savedTasks).map(t => normalizeTask(t));
                    setTasks(parsedTasks);
                }
                if (savedProjects) setProjects(JSON.parse(savedProjects));
                if (savedConfig) setConfig({ ...defaultConfig, ...JSON.parse(savedConfig) });
            }, []);

            useEffect(() => {
                localStorage.setItem('tm_tasks', JSON.stringify(tasks));
                localStorage.setItem('tm_projects', JSON.stringify(projects));
                localStorage.setItem('tm_config', JSON.stringify(config));
                lucide.createIcons();
            }, [tasks, projects, config]);

            // --- LOGIC ---
            
            const getDeadlineLevel = (task) => {
                if (task.status === 'Recorrente') return null;
                if (task.status === 'Concluída' || task.status === 'Cancelada' || !task.deadline) return null;

                const todayStr = getTodayStr();

                if (task.deadline < todayStr) return 'overdue';

                const diffBusinessDays = getBusinessDayDistance(todayStr, task.deadline);

                if (diffBusinessDays <= config.alertRed) return 'red';
                if (diffBusinessDays <= config.alertOrange) return 'orange';
                if (diffBusinessDays <= config.alertYellow) return 'yellow';
                return null;
            };

        const getAlertLevel = (task) => {
            if (task.status === 'Recorrente') return 'border-l-8 border-l-slate-400';
            const level = getDeadlineLevel(task);
            if (!level) return 'border-l-4 border-l-blue-400';

                const map = {
                    overdue: `border-l-8 ${config.overdueColor}`,
                    red: 'border-l-8 border-l-red-500',
                    orange: 'border-l-8 border-l-orange-400',
                    yellow: 'border-l-8 border-l-yellow-400'
                };
                return map[level] || 'border-l-4 border-l-blue-400';
            };

        const updateTaskField = (id, field, value) => {
            setTasks(prev => prev.map(t => t.id === id ? { ...t, [field]: value } : t));
        };

        const adjustTaskExecutionDate = (id, dayShift) => {
            if (!dayShift) return;

            setTasks(prev => prev.map(t => {
                if (t.id !== id) return t;
                const baseDate = getEffectiveDate(t) || getTodayStr();
                return {
                    ...t,
                    date: addDays(baseDate, dayShift),
                    deferBusinessDays: 0
                };
            }));
        };

        const advanceRecurrence = (task) => {
            const nextDate = getNextRecurrenceDate(task);
            if (!nextDate) {
                alert('Configure a recorrência desta tarefa para avançar.');
                    return;
                }
                updateTaskField(task.id, 'date', nextDate);
            };

            const saveTask = (task) => {
                const normalized = normalizeTask(task);

                if (task.id) {
                    setTasks(tasks.map(t => t.id === task.id ? normalized : t));
                } else {
                    setTasks([...tasks, { ...normalized, id: generateId() }]);
                }
                // Adicionar projeto se for novo
                if (!projects.includes(task.project)) {
                    setProjects([...projects, task.project]);
                }
                setModalOpen(false);
                setEditingTask(null);
            };

            const deleteTask = (id) => {
                if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                    setTasks(tasks.filter(t => t.id !== id));
                }
            };

            const toggleSubtask = (taskId, subIndex) => {
                const newTasks = tasks.map(t => {
                    if (t.id === taskId) {
                        const newSub = [...t.subtasks];
                        newSub[subIndex].completed = !newSub[subIndex].completed;
                        return { ...t, subtasks: newSub };
                    }
                    return t;
                });
                setTasks(newTasks);
            };

            const shiftAllTasks = (days, useBusinessDays = true) => {
                if (days === 0 || Number.isNaN(days)) return;

                const absDays = Math.abs(days);
                const unitLabel = useBusinessDays ? (absDays === 1 ? 'dia útil' : 'dias úteis') : (absDays === 1 ? 'dia' : 'dias');
                const directionLabel = days > 0 ? 'adiar' : 'antecipar';

                if (!confirm(`Deseja ${directionLabel} todas as tarefas pendentes em ${absDays} ${unitLabel}?`)) return;

                const shiftDate = (dateStr) => useBusinessDays ? addBusinessDays(dateStr, parseInt(days)) : addDays(dateStr, parseInt(days));

                const fallbackDate = getNextBusinessDay(getTodayStr());

                const newTasks = tasks.map(t => {
                    if (t.status !== 'Concluída' && t.status !== 'Cancelada') {
                        const baseDate = t.date || fallbackDate;
                        return { ...t, date: shiftDate(baseDate) };
                    }
                    return t;
                });
                setTasks(newTasks);
                alert('Tarefas reprogramadas com sucesso!');
            };

            const shiftTasksFromEarliest = (targetDateStr, label) => {
                const pendingTasks = tasks.filter(t => t.status !== 'Concluída' && t.status !== 'Cancelada');
                if (pendingTasks.length === 0) {
                    alert('Não há tarefas pendentes para reprogramar.');
                    return;
                }

                const earliestDate = pendingTasks.reduce((earliest, task) => {
                    if (!task.date) return earliest;
                    if (!earliest || task.date < earliest) return task.date;
                    return earliest;
                }, null);

                if (!earliestDate) {
                    alert('Não há datas definidas para reprogramar.');
                    return;
                }

                const shift = getBusinessDayShift(earliestDate, targetDateStr);

                if (shift === 0) {
                    alert('As tarefas já estão alinhadas com a data escolhida.');
                    return;
                }

                if (!confirm(`Deseja reprogramar todas as tarefas pendentes para começar ${label}?`)) return;

                const fallbackDate = getNextBusinessDay(getTodayStr());

                const newTasks = tasks.map(t => {
                    if (t.status !== 'Concluída' && t.status !== 'Cancelada') {
                        const baseDate = t.date || fallbackDate;
                        return { ...t, date: addBusinessDays(baseDate, shift) };
                    }
                    return t;
                });

                setTasks(newTasks);
                alert('Tarefas reprogramadas com sucesso!');
            };
            
            const exportData = () => {
                const dataStr = JSON.stringify({tasks, projects, config});
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'backup_tarefas.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.tasks) {
                            const normalizedTasks = data.tasks.map(t => normalizeTask(t));
                            setTasks(normalizedTasks);
                        }
                        if(data.projects) setProjects(data.projects);
                        if(data.config) setConfig({ ...defaultConfig, ...data.config });
                        alert('Backup restaurado com sucesso!');
                    } catch (err) {
                        alert('Erro ao ler arquivo.');
                    }
                };
                reader.readAsText(file);
            };

            // --- FILTRAGEM ---
            const todayStr = getTodayStr();
            const tomorrowStr = addDays(todayStr, 1);
            const businessToday = getNextBusinessDay(todayStr);
            const businessTomorrow = addBusinessDays(businessToday, 1);

            const filteredTasks = useMemo(() => {
                return tasks.filter(t => {
                    const executionDate = getEffectiveDate(t);
                    const matchProj = filters.project === 'Todos' || t.project === filters.project;
                    const matchStatus = filters.status === 'Todos'
                        || (filters.status === 'Aberta' ? ['Em Andamento', 'Recorrente'].includes(t.status) : t.status === filters.status);
                    const matchSearch = t.title.toLowerCase().includes(filters.search.toLowerCase());
                    let matchDate = true;

                    if (filters.dateFilter === 'Hoje') {
                        matchDate = executionDate === todayStr;
                    } else if (filters.dateFilter === 'Amanhã') {
                        matchDate = executionDate === tomorrowStr;
                    } else if (filters.dateFilter === 'Período') {
                        if (filters.startDate && executionDate && executionDate < filters.startDate) matchDate = false;
                        if (filters.endDate && executionDate && executionDate > filters.endDate) matchDate = false;
                    }

                    return matchProj && matchStatus && matchSearch && matchDate;
                }).sort((a, b) => {
                    // Ordenar por data, depois agrupar por projeto e priorizar maior prioridade/menor dificuldade
                    const dateA = getEffectiveDate(a);
                    const dateB = getEffectiveDate(b);
                    if (dateA !== dateB) return dateA > dateB ? 1 : -1;
                    if (a.project !== b.project) return a.project.localeCompare(b.project);
                    if (a.priority !== b.priority) return b.priority - a.priority;
                    const difficultyA = Number.isFinite(a.difficulty) ? a.difficulty : 0;
                    const difficultyB = Number.isFinite(b.difficulty) ? b.difficulty : 0;
                    return difficultyA - difficultyB;
                });
            }, [tasks, filters, todayStr, tomorrowStr]);

            const stats = {
                today: tasks.filter(t => getEffectiveDate(t) === todayStr && !['Concluída', 'Cancelada'].includes(t.status)).length,
                tomorrow: tasks.filter(t => getEffectiveDate(t) === tomorrowStr && !['Concluída', 'Cancelada'].includes(t.status)).length,
                late: tasks.filter(t => {
                    const executionDate = getEffectiveDate(t);
                    return executionDate && executionDate < todayStr && !['Concluída', 'Cancelada'].includes(t.status);
                }).length,
                alertOrange: tasks.filter(t => getDeadlineLevel(t) === 'orange').length,
                alertRed: tasks.filter(t => ['red', 'overdue'].includes(getDeadlineLevel(t))).length
            };

            const isPendingTask = (task) => !['Concluída', 'Cancelada'].includes(task.status);

            const isExecutionAfterDeadline = (task) => {
                if (task.status === 'Recorrente') return false;
                const executionDate = getEffectiveDate(task);
                return task.deadline && executionDate && executionDate > task.deadline;
            };

            const getConflictReasons = (task) => {
                const reasons = [];

                const executionDate = getEffectiveDate(task);

                if (task.status === 'Recorrente' && executionDate && executionDate < todayStr) {
                    reasons.push('Recorrência vencida');
                }

                const deadlineLevel = getDeadlineLevel(task);
                if (deadlineLevel === 'overdue') {
                    reasons.push('Deadline alcançado');
                } else if (deadlineLevel === 'red') {
                    reasons.push('Alerta vermelho de deadline');
                } else if (deadlineLevel === 'orange') {
                    reasons.push('Alerta laranja de deadline');
                }

                if (isPendingTask(task) && executionDate && executionDate < todayStr) {
                    reasons.push('Tarefa atrasada');
                }

                if (isExecutionAfterDeadline(task)) {
                    reasons.push('Execução após deadline');
                }

                return [...new Set(reasons)];
            };

            const conflictTasks = useMemo(() => {
                return tasks
                    .map(task => ({ task, reasons: getConflictReasons(task) }))
                    .filter(item => item.reasons.length > 0);
            }, [tasks, todayStr, config]);

            const getCardBackground = (task) => {
                const executionDate = getEffectiveDate(task);
                if (task.status !== 'Recorrente') {
                    if (task.deadline && task.deadline < todayStr && task.status !== 'Concluída' && task.status !== 'Cancelada') {
                        return { backgroundColor: config.deadlineBg };
                    }
                }
                if (executionDate === todayStr) return { backgroundColor: config.todayBg };
                if (executionDate === tomorrowStr) return { backgroundColor: config.tomorrowBg };
                return {};
            };

            const toggleSubtasksVisibility = (taskId) => {
                setExpandedSubtasks(prev => ({ ...prev, [taskId]: !prev[taskId] }));
            };

            const startTitleEdit = (task) => {
                setEditingTitleId(task.id);
                setTitleDrafts(prev => ({ ...prev, [task.id]: task.title }));
            };

            const saveTitleEdit = (task) => {
                const newTitle = (titleDrafts[task.id] || '').trim();
                if (newTitle) {
                    updateTaskField(task.id, 'title', newTitle);
                }
                setEditingTitleId(null);
            };

            const cancelTitleEdit = (task) => {
                setTitleDrafts(prev => ({ ...prev, [task.id]: task.title }));
                setEditingTitleId(null);
            };

            const toggleStatusMenu = (taskId) => {
                setStatusMenuTask(prev => prev === taskId ? null : taskId);
            };

            const changeStatus = (taskId, status) => {
                updateTaskField(taskId, 'status', status);
                setStatusMenuTask(null);
            };

            const addInlineSubtask = (taskId) => {
                const text = (inlineSubtaskText[taskId] || '').trim();
                if (!text) return;
                setTasks(prev => prev.map(t => t.id === taskId ? {
                    ...t,
                    subtasks: [...(t.subtasks || []), { text, completed: false }]
                } : t));
                setInlineSubtaskText(prev => ({ ...prev, [taskId]: '' }));
                setExpandedSubtasks(prev => ({ ...prev, [taskId]: true }));
            };

            const quickAddSubtask = (taskId) => {
                let createdIndex = null;
                setTasks(prev => prev.map(t => {
                    if (t.id === taskId) {
                        const newSubtasks = [...(t.subtasks || []), { text: 'Nova subtarefa', completed: false }];
                        createdIndex = newSubtasks.length - 1;
                        return { ...t, subtasks: newSubtasks };
                    }
                    return t;
                }));
                setExpandedSubtasks(prev => ({ ...prev, [taskId]: true }));
                if (createdIndex !== null) {
                    setSubtaskDrafts(prev => ({ ...prev, [`${taskId}-${createdIndex}`]: 'Nova subtarefa' }));
                    setEditingSubtask({ taskId, index: createdIndex });
                }
            };

            const startEditingSubtask = (taskId, index, currentText) => {
                setEditingSubtask({ taskId, index });
                setSubtaskDrafts(prev => ({ ...prev, [`${taskId}-${index}`]: currentText }));
            };

            const saveEditingSubtask = (taskId, index) => {
                const key = `${taskId}-${index}`;
                const newText = (subtaskDrafts[key] || '').trim();
                if (!newText) {
                    setEditingSubtask(null);
                    return;
                }
                setTasks(prev => prev.map(t => {
                    if (t.id === taskId) {
                        const newSub = [...(t.subtasks || [])];
                        newSub[index] = { ...newSub[index], text: newText };
                        return { ...t, subtasks: newSub };
                    }
                    return t;
                }));
                setEditingSubtask(null);
            };

            const renderTaskCard = (task, conflictReasons = []) => {
                const cardBgStyle = getCardBackground(task);
                const executionDate = getEffectiveDate(task);
                const postponeDays = Number(task.deferBusinessDays) || 0;
                const executionLabel = executionDate
                    ? (executionDate === todayStr
                        ? 'Hoje'
                        : (executionDate === tomorrowStr
                            ? 'Amanhã'
                            : executionDate.split('-').reverse().join('/')))
                    : 'Sem data';
                const baseDateLabel = task.date ? task.date.split('-').reverse().join('/') : '';
                return (
                    <div key={task.id} style={cardBgStyle} className={`bg-white/90 rounded-lg shadow-sm hover:shadow transition p-1.5 border-l-4 ${getAlertLevel(task)} relative group`}>
                        {conflictReasons.length > 0 && (
                            <div className="flex flex-wrap items-center gap-1 text-[11px] text-amber-700 font-semibold mb-1">
                                <Icon name="alert-triangle" size={14} />
                                <span>Conflitos:</span>
                                {conflictReasons.map((reason, idx) => (
                                    <span key={`${task.id}-conflict-${idx}`} className="bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full border border-amber-200">
                                        {reason}
                                    </span>
                                ))}
                            </div>
                        )}
                        <div className="flex justify-between items-start mb-1 gap-2">
                            <div className="flex-1 space-y-1 leading-tight">
                                <div className="flex items-center justify-between gap-2">
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{task.project}</span>
                                    <div className="flex items-center gap-2 text-[11px] text-slate-600">
                                        <RatingDisplay
                                            label="P:"
                                            value={task.priority}
                                            color="text-red-400"
                                            onChange={(val) => updateTaskField(task.id, 'priority', val)}
                                        />
                                        <RatingDisplay
                                            label="D:"
                                            value={task.difficulty}
                                            color="text-blue-400"
                                            onChange={(val) => updateTaskField(task.id, 'difficulty', val)}
                                        />
                                    </div>
                                </div>
                                {editingTitleId === task.id ? (
                                    <input
                                        type="text"
                                        value={titleDrafts[task.id] || ''}
                                        className="text-sm font-bold text-slate-800 leading-tight border rounded px-1 py-0.5 w-full"
                                        onChange={e => setTitleDrafts(prev => ({ ...prev, [task.id]: e.target.value }))}
                                        onBlur={() => saveTitleEdit(task)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') { e.preventDefault(); saveTitleEdit(task); }
                                            if (e.key === 'Escape') { cancelTitleEdit(task); }
                                        }}
                                        autoFocus
                                    />
                                ) : (
                                    <h3
                                        className="text-sm font-bold text-slate-800 leading-tight cursor-text"
                                        onClick={() => startTitleEdit(task)}
                                        title="Clique para editar o título"
                                    >
                                        {task.title}
                                    </h3>
                                )}
                            </div>
                            <div className="flex items-center gap-1.5 text-slate-500">
                                {isExecutionAfterDeadline(task) && (
                                    <span className="text-red-500" title="Execução após o prazo definido">
                                        <Icon name="alert-triangle" size={16} />
                                    </span>
                                )}
                                {task.status === 'Recorrente' && (
                                    <button onClick={() => advanceRecurrence(task)} className="p-1 text-slate-400 hover:text-slate-600 flex items-center gap-1" title="Ir para a próxima ocorrência">
                                        <Icon name="fast-forward" size={14} />
                                        <span className="text-[11px] font-semibold">Próxima</span>
                                    </button>
                                )}
                                <button
                                    onClick={() => quickAddSubtask(task.id)}
                                    className="p-1 text-blue-500 hover:text-blue-700"
                                    title="Adicionar subtarefa rapidamente"
                                >
                                    <Icon name="plus-square" size={14} />
                                </button>
                                <button onClick={() => { setEditingTask(task); setModalOpen(true); }} className="p-1 text-slate-400 hover:text-blue-500"><Icon name="edit-2" size={14}/></button>
                                <button onClick={() => deleteTask(task.id)} className="p-1 text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button>
                            </div>
                        </div>

                        <div className="flex flex-wrap gap-y-1 gap-x-2 text-[12px] text-slate-600 items-center">
                            <div className="flex items-center gap-1" title="Data Execução">
                                <Icon name="calendar" size={14} />
                                {editingDateId === task.id ? (
                                    <input
                                        type="date"
                                        className="border rounded px-2 py-1 text-[11px]"
                                        value={task.date}
                                        onChange={e => { updateTaskField(task.id, 'date', e.target.value); setEditingDateId(null); }}
                                        onBlur={() => setEditingDateId(null)}
                                        autoFocus
                                    />
                                ) : (
                                    <div className="flex items-center gap-1">
                                        <button
                                            type="button"
                                            className={`${executionDate === todayStr ? 'font-bold text-blue-600' : (executionDate === tomorrowStr ? 'font-bold text-indigo-600' : 'hover:underline')}`}
                                            onClick={() => setEditingDateId(task.id)}
                                            title={postponeDays ? `Data base: ${baseDateLabel}` : undefined}
                                        >
                                            {executionLabel}
                                        </button>
                                    </div>
                                )}
                            </div>
                            {task.deadline && (
                                <div className="flex items-center gap-1 text-red-600" title="Deadline">
                                    <Icon name="alert-circle" size={14} />
                                    {editingDeadlineId === task.id ? (
                                        <input
                                            type="date"
                                            className="border rounded px-2 py-1 text-[11px]"
                                            value={task.deadline}
                                            onChange={e => { updateTaskField(task.id, 'deadline', e.target.value); setEditingDeadlineId(null); }}
                                            onBlur={() => setEditingDeadlineId(null)}
                                            autoFocus
                                        />
                                    ) : (
                                        <button type="button" className="hover:underline"
                                            onClick={() => setEditingDeadlineId(task.id)}>
                                            {task.deadline.split('-').reverse().join('/')}
                                        </button>
                                    )}
                                </div>
                            )}
                            <div className="flex items-center gap-1" title="Status">
                                <StatusBadge status={task.status} onClick={() => toggleStatusMenu(task.id)} />
                                {statusMenuTask === task.id && (
                                    <div className="absolute right-0 top-0 mt-6 bg-white shadow-lg rounded border z-10">
                                        {STATUS_OPTIONS.map(s => (
                                            <button key={s} onClick={() => changeStatus(task.id, s)} className="block w-full text-left px-4 py-2 hover:bg-slate-100 text-sm">
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            {task.status !== 'Recorrente' && (
                                <PostponeSelector
                                    baseDate={executionDate}
                                    onShift={(shift) => adjustTaskExecutionDate(task.id, shift)}
                                />
                            )}
                            <div className="flex items-center gap-1" title="Prioridade">
                                <Icon name="flag" size={14} />
                                <span className="font-semibold">{task.priority}/5</span>
                            </div>
                            <div className="flex items-center gap-1" title="Dificuldade">
                                <Icon name="trending-up" size={14} />
                                <span className="font-semibold">{task.difficulty}/5</span>
                            </div>
                            {task.recurrence?.frequency !== 'Nenhuma' && (
                                <div className="flex items-center gap-1 text-purple-600" title="Recorrência">
                                    <Icon name="repeat" size={14} />
                                    <span className="font-semibold">{task.recurrence.frequency}</span>
                                </div>
                            )}
                        </div>

                        {task.notes && (
                            <div className="mt-1 text-[12px] text-slate-500">
                                <button onClick={() => toggleNotesVisibility(task.id)} className="hover:underline flex items-center gap-1">
                                    <Icon name="sticky-note" size={12} /> {expandedNotes[task.id] ? 'Esconder notas' : 'Ver notas'}
                                </button>
                            </div>
                        )}

                        {task.notes && expandedNotes[task.id] && (
                            <div className="mt-1 text-xs text-slate-500 italic leading-snug">
                                Obs: {task.notes}
                            </div>
                        )}

                        {(task.subtasks && task.subtasks.length > 0) && (
                            <div className="mt-2 bg-slate-50 rounded p-2">
                                <button className="text-[11px] text-slate-600 hover:text-slate-900 flex items-center gap-1 mb-2" onClick={() => toggleSubtasksVisibility(task.id)}>
                                    <Icon name={expandedSubtasks[task.id] ? 'chevron-down' : 'chevron-right'} size={12} />
                                    Subtarefas ({task.subtasks.filter(s => s.completed).length}/{task.subtasks.length})
                                </button>
                                {expandedSubtasks[task.id] && (
                                    <div className="space-y-1">
                                        {task.subtasks.map((sub, idx) => (
                                            <div key={idx} className="flex items-center gap-2 text-[12px] text-slate-700">
                                                <input type="checkbox" checked={sub.completed} onChange={() => toggleSubtask(task.id, idx)} />
                                                {editingSubtask?.taskId === task.id && editingSubtask?.index === idx ? (
                                                    <input
                                                        type="text"
                                                        value={subtaskDrafts[`${task.id}-${idx}`] || ''}
                                                        onChange={e => setSubtaskDrafts(prev => ({ ...prev, [`${task.id}-${idx}`]: e.target.value }))}
                                                        onBlur={() => saveEditingSubtask(task.id, idx)}
                                                        onKeyDown={(e) => { if (e.key === 'Enter') saveEditingSubtask(task.id, idx); if (e.key === 'Escape') setEditingSubtask(null); }}
                                                        className="flex-1 border rounded px-2 py-1"
                                                        autoFocus
                                                    />
                                                ) : (
                                                    <span className={`${sub.completed ? 'subtask-done' : ''} flex-1`} onClick={() => startEditingSubtask(task.id, idx, sub.text)}>
                                                        {sub.text}
                                                    </span>
                                                )}
                                            </div>
                                        ))}
                                        <div className="flex items-center gap-2">
                                            <input
                                                type="text"
                                                placeholder="Adicionar subtarefa"
                                                className="flex-1 border rounded px-2 py-1 text-[12px]"
                                                value={inlineSubtaskText[task.id] || ''}
                                                onChange={e => setInlineSubtaskText(prev => ({ ...prev, [task.id]: e.target.value }))}
                                                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); addInlineSubtask(task.id); } }}
                                            />
                                            <button onClick={() => addInlineSubtask(task.id)} className="text-blue-500 hover:text-blue-700 text-sm font-semibold">Incluir</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {task.status === 'Recorrente' && (
                            <div className="mt-2 text-[11px] text-purple-600 bg-purple-50 border border-purple-200 rounded p-2 flex items-center justify-between">
                                <div className="flex items-center gap-1">
                                    <Icon name="clock-3" size={12} /> Próxima ocorrência: {getNextRecurrenceDate(task) || 'Configure a recorrência'}
                                </div>
                                <button onClick={() => advanceRecurrence(task)} className="text-purple-700 hover:text-purple-900 text-xs font-semibold flex items-center gap-1">
                                    <Icon name="skip-forward" size={12} /> Avançar
                                </button>
                            </div>
                        )}

                        {task.status === 'Recorrente' && (
                            <div className="absolute inset-0 rounded-lg border border-purple-200 pointer-events-none"></div>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    {/* SIDEBAR */}
                    <aside className="w-full md:w-64 bg-slate-900 text-white p-6 flex flex-col shadow-xl z-10">
                        <h1 className="text-2xl font-bold flex items-center gap-2 mb-8">
                            <Icon name="check-square" className="text-blue-400" /> TaskMaster
                        </h1>

                        <nav className="flex-1 space-y-2">
                            <button onClick={() => setView('dashboard')} className={`w-full text-left px-4 py-2 rounded flex items-center gap-2 ${view === 'dashboard' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}>
                                <Icon name="layout-dashboard" size={18}/> Dashboard
                            </button>
                            <button onClick={() => setView('conflicts')} className={`w-full text-left px-4 py-2 rounded flex items-center gap-2 ${view === 'conflicts' ? 'bg-amber-500 text-slate-900' : 'hover:bg-slate-800'}`}>
                                <Icon name="alert-octagon" size={18}/> Conflitos
                                {conflictTasks.length > 0 && (
                                    <span className="ml-auto bg-white/20 px-2 py-0.5 rounded-full text-xs font-bold">{conflictTasks.length}</span>
                                )}
                            </button>
                            <button onClick={() => setView('settings')} className={`w-full text-left px-4 py-2 rounded flex items-center gap-2 ${view === 'settings' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}>
                                <Icon name="settings" size={18}/> Configurações
                            </button>
                        </nav>

                        <div className="mt-8 pt-8 border-t border-slate-700 space-y-4">
                            <div className="flex justify-between items-center text-sm">
                                <span className="text-slate-400">Hoje</span>
                                <span className="bg-blue-500 px-2 rounded-full text-xs font-bold">{stats.today}</span>
                            </div>
                            <div className="flex justify-between items-center text-sm">
                                <span className="text-slate-400">Amanhã</span>
                                <span className="bg-indigo-500 px-2 rounded-full text-xs font-bold">{stats.tomorrow}</span>
                            </div>
                            <div className="flex justify-between items-center text-sm">
                                <span className="text-slate-400">Atrasadas</span>
                                <span className="bg-red-500 px-2 rounded-full text-xs font-bold">{stats.late}</span>
                            </div>
                            <div className="flex justify-between items-center text-sm">
                                <span className="text-slate-400">Alerta Laranja</span>
                                <span className="bg-orange-300 text-slate-900 px-2 rounded-full text-xs font-bold">{stats.alertOrange}</span>
                            </div>
                            <div className="flex justify-between items-center text-sm">
                                <span className="text-slate-400">Alerta Vermelho</span>
                                <span className="bg-red-400 text-white px-2 rounded-full text-xs font-bold">{stats.alertRed}</span>
                            </div>
                        </div>
                        
                        <button onClick={() => { setEditingTask(null); setModalOpen(true); }} className="mt-6 w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded font-bold shadow-lg flex justify-center items-center gap-2 transition">
                            <Icon name="plus" /> Nova Tarefa
                        </button>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 overflow-y-auto h-screen bg-slate-100 p-4 md:p-6">
                        
                        {view === 'dashboard' && (
                            <div className="max-w-5xl mx-auto">
                                {/* Filters Bar */}
                                <div className="bg-white p-3 rounded-lg shadow-sm mb-4 flex flex-col md:flex-row gap-3 items-end md:items-center justify-between">
                                    <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto items-start md:items-center">
                                        <select className="border rounded px-2 py-1.5 text-sm" value={filters.project} onChange={e => setFilters({...filters, project: e.target.value})}>
                                            <option value="Todos">Todos Projetos</option>
                                            {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                        </select>
                                        <select className="border rounded px-2 py-1.5 text-sm" value={filters.status} onChange={e => setFilters({...filters, status: e.target.value})}>
                                            <option value="Todos">Todos Status</option>
                                            <option value="Aberta">Aberta</option>
                                            <option>Em Andamento</option>
                                            <option>Concluída</option>
                                            <option>Recorrente</option>
                                            <option>Cancelada</option>
                                        </select>
                                        <div className="flex gap-2 items-center">
                                            <select className="border rounded px-2 py-1.5 text-sm" value={filters.dateFilter} onChange={e => setFilters({...filters, dateFilter: e.target.value})}>
                                                <option value="Todos">Todas Datas</option>
                                                <option value="Hoje">Hoje</option>
                                                <option value="Amanhã">Amanhã</option>
                                                <option value="Período">Período</option>
                                            </select>
                                            {filters.dateFilter === 'Período' && (
                                                <div className="flex gap-2 items-center text-xs text-slate-500">
                                                    <input type="date" className="border rounded px-2 py-1" value={filters.startDate} onChange={e => setFilters({...filters, startDate: e.target.value})} />
                                                    <span>a</span>
                                                    <input type="date" className="border rounded px-2 py-1" value={filters.endDate} onChange={e => setFilters({...filters, endDate: e.target.value})} />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="w-full md:w-64">
                                        <input type="text" placeholder="Buscar tarefa..." className="border rounded px-2 py-1.5 w-full text-sm" value={filters.search} onChange={e => setFilters({...filters, search: e.target.value})} />
                                    </div>
                                </div>

                                {/* Tasks Grid */}
                                <div className="grid gap-3">
                                    {filteredTasks.length === 0 && (
                                        <div className="text-center text-slate-400 py-10">Nenhuma tarefa encontrada.</div>
                                    )}

                                    {filteredTasks.map(task => renderTaskCard(task))}
                                </div>
                            </div>
                        )}

                        {view === 'conflicts' && (
                            <div className="max-w-5xl mx-auto">
                                <div className="bg-white rounded-lg shadow p-4 flex items-center gap-3 mb-4">
                                    <div className="flex items-center justify-center w-10 h-10 rounded-full bg-amber-100 text-amber-700">
                                        <Icon name="alert-octagon" />
                                    </div>
                                    <div className="flex-1">
                                        <h2 className="text-lg font-bold text-slate-800">Tarefas com Conflitos</h2>
                                        <p className="text-sm text-slate-600">Recorrências vencidas, alertas críticos de deadline, tarefas atrasadas ou com execução após o prazo.</p>
                                    </div>
                                    <span className="text-sm font-bold text-amber-700 bg-amber-50 px-3 py-1 rounded-full border border-amber-200">{conflictTasks.length} itens</span>
                                </div>

                                <div className="grid gap-3">
                                    {conflictTasks.length === 0 && (
                                        <div className="text-center text-slate-400 py-10">Nenhum conflito encontrado no momento.</div>
                                    )}

                                    {conflictTasks.map(({ task, reasons }) => renderTaskCard(task, reasons))}
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
                                <h2 className="text-xl font-bold mb-6 border-b pb-2">Configurações</h2>
                                
                                <div className="mb-8">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="bell" className="text-yellow-500" /> Configuração de Alertas (Deadline)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">Alerta Amarelo (Dias antes)</label>
                                            <input type="number" value={config.alertYellow} onChange={e => setConfig({...config, alertYellow: parseInt(e.target.value)})} className="border rounded p-2 w-full" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">Alerta Laranja (Dias antes)</label>
                                            <input type="number" value={config.alertOrange} onChange={e => setConfig({...config, alertOrange: parseInt(e.target.value)})} className="border rounded p-2 w-full" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">Alerta Vermelho (Dias antes)</label>
                                            <input type="number" value={config.alertRed} onChange={e => setConfig({...config, alertRed: parseInt(e.target.value)})} className="border rounded p-2 w-full" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">Cor fundo Hoje</label>
                                            <input type="color" value={config.todayBg} onChange={e => setConfig({...config, todayBg: e.target.value})} className="border rounded p-2 w-full" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">Cor fundo Amanhã</label>
                                            <input type="color" value={config.tomorrowBg} onChange={e => setConfig({...config, tomorrowBg: e.target.value})} className="border rounded p-2 w-full" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">Cor fundo Deadline Atingido</label>
                                            <input type="color" value={config.deadlineBg} onChange={e => setConfig({...config, deadlineBg: e.target.value})} className="border rounded p-2 w-full" />
                                        </div>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2">Se o deadline passar, a tarefa utilizará a cor escolhida e a borda preta configurada.</p>
                                </div>

                                <div className="mb-8 border-t pt-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="calendar-clock" className="text-blue-500" /> Reprogramação em Massa (Shift)</h3>
                                    <p className="text-sm text-slate-600 mb-3">Empurrar data de execução de todas as tarefas pendentes.</p>
                                    <div className="flex flex-wrap gap-2">
                                        <button onClick={() => shiftAllTasks(1)} className="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200">+1 Dia</button>
                                        <button onClick={() => shiftAllTasks(3)} className="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200">+3 Dias</button>
                                        <button onClick={() => shiftAllTasks(7, false)} className="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200">+1 Semana</button>
                                        <button onClick={() => shiftTasksFromEarliest(businessToday, 'a partir de hoje')} className="bg-indigo-100 text-indigo-700 px-4 py-2 rounded hover:bg-indigo-200">A partir de hoje</button>
                                        <button onClick={() => shiftTasksFromEarliest(businessTomorrow, 'a partir de amanhã')} className="bg-indigo-100 text-indigo-700 px-4 py-2 rounded hover:bg-indigo-200">A partir de amanhã</button>
                                    </div>
                                    <div className="flex flex-col md:flex-row md:items-end gap-3 mt-4">
                                        <div className="flex flex-col gap-1 w-full md:w-auto">
                                            <label className="text-sm text-slate-600">Offset em dias úteis</label>
                                            <input
                                                type="text"
                                                value={reprogramOffset}
                                                onChange={e => setReprogramOffset(e.target.value)}
                                                placeholder="Ex.: +1 ou -2"
                                                className="border rounded px-3 py-2 w-full md:min-w-[160px]"
                                            />
                                            <p className="text-xs text-slate-500">Use valores positivos ou negativos para adiar ou antecipar.</p>
                                        </div>
                                        <button
                                            onClick={() => {
                                                const value = parseInt(reprogramOffset, 10);
                                                if (Number.isNaN(value) || value === 0) {
                                                    alert('Informe um offset diferente de zero.');
                                                    return;
                                                }
                                                shiftAllTasks(value, true);
                                            }}
                                            className="bg-amber-100 text-amber-800 px-4 py-2 rounded hover:bg-amber-200 font-semibold"
                                        >
                                            Aplicar offset
                                        </button>
                                    </div>
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="database" className="text-green-500" /> Backup de Dados</h3>
                                    <div className="flex gap-4">
                                        <button onClick={exportData} className="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700 flex items-center gap-2">
                                            <Icon name="download" size={16} /> Exportar Backup
                                        </button>
                                        <label className="bg-slate-200 text-slate-800 px-4 py-2 rounded hover:bg-slate-300 cursor-pointer flex items-center gap-2">
                                            <Icon name="upload" size={16} /> Restaurar Backup
                                            <input type="file" className="hidden" onChange={importData} accept=".json" />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>

                    {/* TASK MODAL (Form) */}
                    {modalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-animate">
                                <TaskForm 
                                    task={editingTask} 
                                    projects={projects} 
                                    onSave={saveTask} 
                                    onCancel={() => setModalOpen(false)} 
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // 4. TASK FORM COMPONENT
        function TaskForm({ task, projects, onSave, onCancel }) {
            const initialTask = task ? { ...task, recurrence: { ...defaultRecurrence, ...(task.recurrence || {}) } } : {
                title: '',
                project: projects[0] || 'Geral',
                date: getTodayStr(),
                deadline: '',
                status: 'Em Andamento',
                priority: 3,
                difficulty: 3,
                deferBusinessDays: 0,
                notes: '',
                subtasks: [],
                recurrence: { ...defaultRecurrence }
            };

            const [formData, setFormData] = useState(initialTask);

            const [newProject, setNewProject] = useState('');
            const [showNewProjInput, setShowNewProjInput] = useState(false);
            const [tempSubtask, setTempSubtask] = useState('');
            const [monthDaysInput, setMonthDaysInput] = useState((initialTask.recurrence?.daysOfMonth || []).join(','));

            useEffect(() => {
                setFormData(task ? { ...task, recurrence: { ...defaultRecurrence, ...(task.recurrence || {}) } } : initialTask);
                setMonthDaysInput(((task && task.recurrence?.daysOfMonth) || initialTask.recurrence?.daysOfMonth || []).join(','));
            }, [task]);

            const updateRecurrence = (changes) => {
                setFormData(prev => ({
                    ...prev,
                    recurrence: { ...defaultRecurrence, ...(prev.recurrence || {}), ...changes }
                }));
            };

            const submitForm = () => {
                let recurrenceData = { ...defaultRecurrence, ...(formData.recurrence || {}) };

                if (formData.status === 'Recorrente') {
                    if (recurrenceData.frequency === 'Mensal') {
                        const parsed = monthDaysInput
                            .split(',')
                            .map(v => parseInt(v.trim()))
                            .filter(v => !isNaN(v) && v >= 1 && v <= 31);
                        recurrenceData = { ...recurrenceData, daysOfMonth: parsed };
                    }

                    if (recurrenceData.frequency === 'Semanal' && (!recurrenceData.daysOfWeek || recurrenceData.daysOfWeek.length === 0)) {
                        alert('Escolha pelo menos um dia da semana para a recorrência.');
                        return;
                    }

                    if (recurrenceData.frequency === 'Mensal' && (!recurrenceData.daysOfMonth || recurrenceData.daysOfMonth.length === 0)) {
                        alert('Informe pelo menos um dia do mês para a recorrência.');
                        return;
                    }
                } else {
                    recurrenceData = { ...defaultRecurrence };
                }

                onSave({
                    ...formData,
                    project: showNewProjInput && newProject ? newProject : formData.project,
                    recurrence: recurrenceData
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                submitForm();
            };

            const addSubtask = () => {
                if (!tempSubtask.trim()) return;
                setFormData({...formData, subtasks: [...(formData.subtasks || []), { text: tempSubtask, completed: false }]});
                setTempSubtask('');
            };

            const removeSubtask = (index) => {
                const newSubs = [...formData.subtasks];
                newSubs.splice(index, 1);
                setFormData({...formData, subtasks: newSubs});
            };

            return (
                <form onSubmit={handleSubmit} onKeyDown={(e) => {
                    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && !e.target.dataset.preventSubmit) {
                        e.preventDefault();
                        submitForm();
                    }
                }} className="p-5">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 className="text-xl font-bold text-slate-800">{task ? 'Editar Tarefa' : 'Nova Tarefa'}</h2>
                        <button type="button" onClick={onCancel} className="text-slate-400 hover:text-slate-600"><Icon name="x" /></button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div className="col-span-2">
                            <label className="block text-sm font-bold text-slate-700 mb-1">Título da Tarefa</label>
                            <input required type="text" className="w-full border p-2 rounded" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Projeto</label>
                            {!showNewProjInput ? (
                                <div className="flex gap-2">
                                    <select className="w-full border p-2 rounded" value={formData.project} onChange={e => setFormData({...formData, project: e.target.value})}>
                                        {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                    <button type="button" onClick={() => setShowNewProjInput(true)} className="bg-slate-200 p-2 rounded hover:bg-slate-300" title="Novo Projeto"><Icon name="plus" size={16}/></button>
                                </div>
                            ) : (
                                <div className="flex gap-2">
                                    <input type="text" placeholder="Nome do projeto" className="w-full border p-2 rounded" value={newProject} onChange={e => setNewProject(e.target.value)} />
                                    <button type="button" onClick={() => setShowNewProjInput(false)} className="text-red-500 p-2"><Icon name="x" size={16}/></button>
                                </div>
                            )}
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Status</label>
                            <select className="w-full border p-2 rounded" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                                <option>Em Andamento</option>
                                <option>Concluída</option>
                                <option>Recorrente</option>
                                <option>Cancelada</option>
                            </select>
                        </div>

                        {formData.status === 'Recorrente' && (
                            <div className="col-span-2 bg-slate-50 border border-slate-200 p-3 rounded space-y-3">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Frequência da Recorrência</label>
                                    <select
                                        className="w-full border p-2 rounded"
                                        value={formData.recurrence?.frequency || 'Nenhuma'}
                                        onChange={e => updateRecurrence({ frequency: e.target.value })}
                                    >
                                        <option value="Nenhuma">Selecione</option>
                                        <option value="Diária">Diária</option>
                                        <option value="Semanal">Semanal</option>
                                        <option value="Mensal">Mensal</option>
                                    </select>
                                </div>

                                {formData.recurrence?.frequency === 'Semanal' && (
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">Dias da Semana</label>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                            {WEEKDAY_LABELS.map((day, idx) => {
                                                const selected = (formData.recurrence?.daysOfWeek || []).includes(idx);
                                                return (
                                                    <label key={day} className={`flex items-center gap-2 p-2 border rounded cursor-pointer ${selected ? 'bg-blue-50 border-blue-300' : 'bg-white'}`}>
                                                        <input
                                                            type="checkbox"
                                                            checked={selected}
                                                            onChange={() => {
                                                                const current = formData.recurrence?.daysOfWeek || [];
                                                                const next = current.includes(idx) ? current.filter(d => d !== idx) : [...current, idx];
                                                                updateRecurrence({ daysOfWeek: next });
                                                            }}
                                                        />
                                                        {day}
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {formData.recurrence?.frequency === 'Mensal' && (
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">Dias do Mês (separe com vírgula)</label>
                                        <input
                                            type="text"
                                            className="w-full border p-2 rounded"
                                            placeholder="Ex: 1, 15, 30"
                                            value={monthDaysInput}
                                            onChange={e => {
                                                setMonthDaysInput(e.target.value);
                                                const parsed = e.target.value
                                                    .split(',')
                                                    .map(v => parseInt(v.trim()))
                                                    .filter(v => !isNaN(v) && v >= 1 && v <= 31);
                                                updateRecurrence({ daysOfMonth: parsed });
                                            }}
                                        />
                                        <p className="text-xs text-slate-500 mt-1">A tarefa irá para o próximo dia informado ao clicar em "Próxima".</p>
                                    </div>
                                )}
                            </div>
                        )}



                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Data Execução</label>
                            <input type="date" required className="w-full border p-2 rounded" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-red-600 mb-1">Deadline (Prazo Final)</label>
                            <input type="date" className="w-full border border-red-200 p-2 rounded bg-red-50" value={formData.deadline} onChange={e => setFormData({...formData, deadline: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Prioridade (1-5)</label>
                            <input type="range" min="1" max="5" className="w-full" value={formData.priority} onChange={e => setFormData({...formData, priority: parseInt(e.target.value)})} />
                            <div className="flex justify-between text-xs text-slate-400"><span>Baixa</span><span>Alta</span></div>
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Dificuldade (1-5)</label>
                            <input type="range" min="1" max="5" className="w-full" value={formData.difficulty} onChange={e => setFormData({...formData, difficulty: parseInt(e.target.value)})} />
                             <div className="flex justify-between text-xs text-slate-400"><span>Fácil</span><span>Difícil</span></div>
                        </div>
                        
                        <div className="col-span-2">
                             <label className="block text-sm font-bold text-slate-700 mb-1">Subtarefas</label>
                             <div className="flex gap-2 mb-2">
                                <input type="text" placeholder="Adicionar item..." className="flex-1 border p-2 rounded text-sm" value={tempSubtask} onChange={e => setTempSubtask(e.target.value)} data-prevent-submit="true" onKeyPress={e => e.key === 'Enter' && (e.preventDefault(), addSubtask())} />
                                <button type="button" onClick={addSubtask} className="bg-blue-100 text-blue-600 px-3 rounded font-bold">+</button>
                             </div>
                             <ul className="space-y-1">
                                {(formData.subtasks || []).map((sub, idx) => (
                                    <li key={idx} className="flex justify-between bg-slate-50 p-2 rounded text-sm">
                                        <span>{sub.text}</span>
                                        <button type="button" onClick={() => removeSubtask(idx)} className="text-red-400 hover:text-red-600"><Icon name="x" size={14}/></button>
                                    </li>
                                ))}
                             </ul>
                        </div>

                        <div className="col-span-2">
                            <label className="block text-sm font-bold text-slate-700 mb-1">Observações</label>
                            <textarea className="w-full border p-2 rounded h-20" value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})}></textarea>
                        </div>
                    </div>

                    <div className="flex justify-end gap-3 mt-4 pt-3 border-t">
                        <button type="button" onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancelar</button>
                        <button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-lg">Salvar Tarefa</button>
                    </div>
                </form>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
